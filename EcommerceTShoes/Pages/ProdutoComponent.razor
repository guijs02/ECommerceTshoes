@page "/details/{CurrentId:int}/{IsUpdate:bool}"

@using EcommerceAPI.Services.Interfaces;
@using EcommerceWeb.Model;
@using EcommerceWeb.Pages
@using EcommerceWeb.Modals;

@inject ITShoesService _service
@inject ICarrinhoService _Carrinhoservice
@inject NavigationManager _navigation

@if (OnInitializeCompleted)
{

    <html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
        <title>Tênis</title>

    </head>
    <NavTShoes></NavTShoes>
    <br>
    <br>
    <body>
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <img src="@Produto.ImagemUrl" class="img-fluid" alt="Tênis">
                </div>
                <div class="col-md-6">
                    <h1 class="mb-4">@Produto.Nome</h1>
                    <p class="lead mb-4">Indicado para: todos que querem andar estilosos pela rua</p>
                    <h4 class="mb-3">Descrição:</h4>
                    <p>@Produto.Descricao</p>
                    <h4 class="mb-3">Marca:</h4>
                    <p>@Produto.Nome</p>
                    <h4 class="mb-3">Garantia do fabricante:</h4>
                    <p>2 anos de garantia</p>
                    <h4 class="mb-3">Origem:</h4>
                    <p>Nacional</p>
                    <h4 class="mb-3">Altura do Cano:</h4>
                    <p>Cano Baixo</p>
                </div>
            </div>
            <EditForm EditContext="@editContext" Model="Produto">

                <div class="row mt-4">
                    <div class="col-md-6">
                        <p class="h3">@Produto.Preco.ToString("C")</p>
                        <p class="text-muted">ou 10x de R$ @(Math.Round(Produto.Preco / 10, 2).ToString("C")) sem juros</p>
                    </div>
                    <div class="col-md-6">
                        <label for="tamanho">Tamanho:</label>
                        <InputSelect @bind-Value="@Produto.Tamanho">
                            <option value="38">38</option>
                            <option value="39">39</option>
                            <option value="40">40</option>
                            <option value="41">41</option>
                            <option value="42">42</option>
                            <option value="43">43</option>
                            <option value="44">44</option>
                        </InputSelect>
                        <p style="color:@SetColorMessage">@Mensagem</p>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-12">
                        <button class="btn btn-primary" @onclick="@(async () => await AddCart())">@TextButtonAddCarrinho</button>
                    </div>
                </div>
            </EditForm>
        </div>

    </body>

    @if (VisualizarModalAddCart)
    {
        <ModalNotify carrinhoDeCompra="CarrinhoDeCompra"
                     IsUpdate="IsUpdate"
                     Visible="@VisualizarModalAddCart"
                     VisibleModalCallback="@(() => VisualizarModalAddCart = false)">
        </ModalNotify>

    }
    </html>
}
<style>

    .html {
        height: 100vh;
    }
</style>
@code {
    private EditContext? editContext;
    [Parameter]
    public int CurrentId { get; set; }
    [Parameter]
    public bool IsUpdate { get; set; }
    public bool VisualizarModalAddCart { get; set; }
    public Produto Produto { get; set; }
    public string SetColorMessage { get; set; }
    public bool OnInitializeCompleted { get; set; }
    public string Mensagem { get; set; } = string.Empty;
    public string TextButtonAddCarrinho { get; set; }
    CarrinhoDeCompra? CarrinhoDeCompra { get; set; }

    protected override async Task OnInitializedAsync()
    {

        if (IsUpdate)
        {
            Produto = await _Carrinhoservice.GetByIdProdutoCarrinho(CurrentId);
            TextButtonAddCarrinho = "Alterar Produto do Carrinho";
        }
        else
        {
            Produto = await _service.GetProduto(CurrentId);
            TextButtonAddCarrinho = "Adicionar ao Carrinho";
        }

        OnInitializeCompleted = true;
    }
    public async Task AddCart()
    {

        if (string.IsNullOrEmpty(Produto.Tamanho))
        {
            SetColorMessage = GlobalConstants.RED;
            Mensagem = "Não é possivel salvar no carrinho sem colocar o tamanho";
            await Task.Delay(5000).ContinueWith(_ =>
                {
                    SetColorMessage = GlobalConstants.WHITE;
                });
            return;
        }
        if (IsUpdate)
        {
            CarrinhoDeCompra = await _Carrinhoservice.EditCarrinho(Produto);
            VisualizarModalAddCart = true;
            return;
        }
 
        
        CarrinhoDeCompra = await _Carrinhoservice.AddCart(Produto);
        VisualizarModalAddCart = true;

    }

}
